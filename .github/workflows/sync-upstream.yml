name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
    - cron: '0 2 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    name: åŒæ­¥ä¸Šæ¸¸ä»“åº“æ›´æ–°
    
    # ä»…åœ¨Forkä»“åº“ä¸­è¿è¡Œæ­¤å·¥ä½œæµ
    if: github.repository != 'chiupam/tieba'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          # ä½¿ç”¨é»˜è®¤çš„GITHUB_TOKENï¼Œå®ƒå¯¹å½“å‰ä»“åº“æœ‰å†™æƒé™
          token: ${{ github.token }}
      
      - name: é…ç½®Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
        run: |
          # æ·»åŠ chiupam/tiebaä½œä¸ºä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/chiupam/tieba.git
          git remote -v
      
      - name: è·å–ä¸Šæ¸¸æ›´æ–°
        run: |
          git fetch upstream
          echo "âœ… æˆåŠŸè·å–ä¸Šæ¸¸ä»“åº“çš„æœ€æ–°ä»£ç "
          
      - name: å¤‡ä»½éœ€è¦ä¿ç•™çš„æ–‡ä»¶
        run: |
          if [ -f "last_activity.md" ]; then
            echo "ğŸ“¦ å¤‡ä»½æœ¬åœ°çš„ last_activity.md æ–‡ä»¶"
            cp last_activity.md last_activity.md.backup
          fi
      
      - name: åˆå¹¶ä¸Šæ¸¸å˜æ›´
        run: |
          # æ£€æŸ¥å½“å‰åˆ†æ”¯
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
          
          # æ‰§è¡Œåˆå¹¶
          if git merge upstream/$CURRENT_BRANCH --no-edit; then
            echo "âœ… å·²æˆåŠŸåˆå¹¶ä¸Šæ¸¸ä»“åº“çš„å˜æ›´"
          else
            echo "âš ï¸ åˆå¹¶è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨å†²çªï¼Œå°è¯•ä½¿ç”¨ç­–ç•¥è§£å†³..."
            # å°è¯•ä½¿ç”¨theirsç­–ç•¥è§£å†³å†²çªï¼ˆæ¥å—ä¸Šæ¸¸æ›´æ”¹ï¼‰
            git merge --abort
            git merge upstream/$CURRENT_BRANCH -X theirs --no-edit
            echo "âš ï¸ ä½¿ç”¨theirsåˆå¹¶ç­–ç•¥å®Œæˆï¼Œå¦‚æœ‰å¼‚å¸¸è¯·æ‰‹åŠ¨æ£€æŸ¥"
          fi
          
      - name: æ¢å¤éœ€è¦ä¿ç•™çš„æ–‡ä»¶
        run: |
          if [ -f "last_activity.md.backup" ]; then
            echo "ğŸ“¦ æ¢å¤æœ¬åœ°çš„ last_activity.md æ–‡ä»¶"
            mv last_activity.md.backup last_activity.md
            git add last_activity.md
            git commit -m "ä¿ç•™æœ¬åœ° last_activity.md æ–‡ä»¶" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi
      
      - name: æ¨é€æ›´æ–°
        run: |
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          # åªæ¨é€åˆ°Forkçš„ä»“åº“ï¼Œä¸å°è¯•æ¨é€åˆ°ä¸Šæ¸¸ä»“åº“
          if git push origin $CURRENT_BRANCH; then
            echo "âœ… å·²å°†æ›´æ–°æ¨é€åˆ°æ‚¨çš„ä»“åº“"
          else
            echo "âŒ æ¨é€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ£€æŸ¥"
            exit 1
          fi
      
      - name: åŒæ­¥å®Œæˆ
        run: |
          echo "ğŸ‰ æ‚¨çš„ä»“åº“å·²ä¸ä¸Šæ¸¸ä»“åº“åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ æœ€æ–°æäº¤ä¿¡æ¯ï¼š"
          git log -1 --pretty=format:"%h - %an: %s" 